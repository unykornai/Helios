{% extends "base.html" %}
{% block title %}Member Advisory â€” Helios Protocol{% endblock %}
{% block og_title %}Member Advisory â€” Helios Protocol{% endblock %}
{% block og_description %}AI-powered advisory for the Helios protocol. Understand settlement mechanics, reserve composition, allocation formulas, and smart contract structure.{% endblock %}
{% block og_url %}/ask{% endblock %}

{% block head %}
<style>
/* â”€â”€â”€ Avatar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.avatar-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
.helios-avatar { width: 140px; height: 140px; cursor: pointer; transition: transform .3s; }
.helios-avatar:hover { transform: scale(1.02); }
.avatar-rings { animation: avatar-idle 10s ease-in-out infinite; }
.avatar-core { filter: drop-shadow(0 0 8px rgba(41,151,255,0.3)); }
@keyframes avatar-idle {
    0%,100% { opacity: .5; }
    50% { opacity: .9; }
}
@keyframes avatar-speak {
    0%,100% { r: 16; opacity: .7; }
    25% { r: 19; opacity: 1; }
    50% { r: 14; opacity: .6; }
    75% { r: 20; opacity: .9; }
}
@keyframes avatar-ring-pulse {
    0%,100% { stroke-width: 1.5; opacity: .3; }
    50% { stroke-width: 2.5; opacity: .5; }
}
.avatar-speaking .avatar-core-circle { animation: avatar-speak .6s ease-in-out infinite; }
.avatar-speaking .avatar-rings circle { animation: avatar-ring-pulse 1.2s ease-in-out infinite; }
.avatar-speaking .avatar-rays line { animation: ray-pulse .8s ease-in-out infinite alternate; }
@keyframes ray-pulse {
    0% { stroke-opacity: .3; stroke-width: 1.5; }
    100% { stroke-opacity: .7; stroke-width: 2.5; }
}
.avatar-thinking .avatar-core-circle { animation: avatar-think 2s ease-in-out infinite; }
@keyframes avatar-think {
    0%,100% { r: 16; fill-opacity: .8; }
    50% { r: 12; fill-opacity: .5; }
}
.avatar-label {
    margin-top: .75rem; font-size: .8rem; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: .15em; font-weight: 600;
    transition: color .3s; font-family: 'Inter', sans-serif;
}
.avatar-speaking + .avatar-label { color: var(--gold); }
.avatar-status {
    font-size: .75rem; color: var(--text-muted); margin-top: .25rem;
    min-height: 1.1rem; font-family: 'Inter', sans-serif;
}

/* â”€â”€â”€ Topic Guide Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.guide-section { margin-bottom: 1.8rem; }
.guide-title {
    font-size: .72rem; text-transform: uppercase; letter-spacing: .12em;
    color: var(--text-muted); font-weight: 600; margin-bottom: .65rem;
    padding-left: .2rem; font-family: 'Inter', sans-serif;
}
.topic-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: .55rem;
}
.topic-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: .75rem 1rem;
    cursor: pointer; transition: all .25s;
    display: flex; align-items: center; gap: .6rem;
}
.topic-card:hover {
    border-color: rgba(41,151,255,0.25);
    background: rgba(41,151,255,0.03);
    transform: translateY(-1px);
}
.topic-marker {
    width: 32px; height: 32px; border-radius: 50%;
    background: rgba(41,151,255,0.08); border: 1px solid rgba(41,151,255,0.15);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-size: .75rem; font-weight: 700;
    color: var(--gold); font-family: 'Inter', sans-serif;
}
.topic-text {
    font-size: .85rem; font-weight: 600; color: var(--text);
    line-height: 1.3;
}
.topic-sub { font-size: .72rem; color: var(--text-muted); font-weight: 400; font-family: 'Inter', sans-serif; }

/* â”€â”€â”€ Voice Toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.voice-toggle-bar {
    display: inline-flex; align-items: center;
    gap: .8rem; padding: .45rem 1rem; border-radius: 20px;
    background: var(--bg-card); border: 1px solid var(--border);
    font-family: 'Inter', sans-serif;
}
.voice-toggle-wrap { display: flex; justify-content: center; margin-bottom: 1.5rem; }
.voice-toggle-label { font-size: .78rem; color: var(--text-muted); font-weight: 600; }
.voice-toggle {
    width: 36px; height: 20px; border-radius: 10px;
    background: var(--border); position: relative;
    cursor: pointer; transition: background .3s;
}
.voice-toggle.active { background: var(--gold); }
.voice-toggle::after {
    content: ''; position: absolute; top: 2px; left: 2px;
    width: 16px; height: 16px; border-radius: 50%;
    background: white; transition: transform .3s;
}
.voice-toggle.active::after { transform: translateX(16px); }

/* â”€â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-container {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); max-height: 400px; overflow-y: auto;
    margin-bottom: 1rem; scroll-behavior: smooth;
}
.chat-messages { padding: 1rem; }
.chat-message {
    display: flex; gap: .75rem; margin-bottom: 1rem;
    animation: msgFadeIn .3s ease;
}
@keyframes msgFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}
.chat-message.user { flex-direction: row-reverse; }
.msg-avatar {
    width: 32px; height: 32px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: .8rem; flex-shrink: 0;
    background: var(--bg); font-weight: 600;
    color: var(--gold); font-family: 'Inter', sans-serif;
}
.msg-content {
    max-width: 80%; padding: .75rem 1rem;
    border-radius: var(--radius);
    font-size: .92rem; line-height: 1.6;
}
.chat-message.assistant .msg-content {
    background: rgba(41,151,255,0.04);
    border: 1px solid rgba(41,151,255,0.1);
    color: var(--text);
}
.chat-message.user .msg-content {
    background: rgba(74,126,181,0.08);
    border: 1px solid rgba(74,126,181,0.12);
    color: var(--text);
}
.msg-content p { margin: 0; }
.voice-btn {
    background: none; border: none; cursor: pointer;
    font-size: 1rem; margin-top: .4rem; padding: .2rem;
    opacity: .5; transition: opacity .2s;
}
.voice-btn:hover { opacity: 1; }
.voice-btn.playing { opacity: 1; color: var(--gold); }
.follow-up {
    display: flex; flex-wrap: wrap; gap: .4rem;
    padding: 0 1rem .5rem;
}
.follow-btn {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: 16px; padding: .3rem .8rem;
    font-size: .75rem; color: var(--text-muted);
    cursor: pointer; transition: all .2s;
    font-family: 'Inter', sans-serif;
}
.follow-btn:hover {
    border-color: var(--gold); color: var(--gold);
    background: rgba(41,151,255,0.04);
}
.chat-input-area {
    display: flex; gap: .5rem;
}
.chat-input-area input {
    flex: 1; padding: .7rem 1rem;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); color: var(--text);
    font-size: .95rem; font-family: 'EB Garamond', serif;
}
.chat-input-area input:focus {
    outline: none; border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(41,151,255,0.1);
}
.chat-input-area .btn { white-space: nowrap; }

/* â”€â”€â”€ Page Links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.page-links {
    display: flex; flex-wrap: wrap; gap: .5rem;
    justify-content: center;
    margin-top: 1.5rem; padding: 1rem 0;
    border-top: 1px solid var(--border);
}
.page-link {
    padding: .4rem .8rem; border-radius: 20px;
    font-size: .75rem; font-weight: 600;
    border: 1px solid var(--border); color: var(--text-muted);
    text-decoration: none; transition: all .2s;
    font-family: 'Inter', sans-serif;
}
.page-link:hover { border-color: var(--gold); color: var(--gold); }

@media (max-width: 768px) {
    .topic-grid { grid-template-columns: 1fr 1fr; }
}
@media (max-width: 480px) {
    .topic-grid { grid-template-columns: 1fr; }
    .helios-avatar { width: 110px; height: 110px; }
}
</style>
{% endblock %}

{% block content %}
<section class="section ask-section">
    <div class="container container-sm">
        <!-- â•â•â• ADVISORY AVATAR â•â•â• -->
        <div class="avatar-container">
            <svg class="helios-avatar" id="helios-avatar" viewBox="0 0 160 160" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="avatarGlow" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" style="stop-color:#93c5fd;stop-opacity:0.7"/>
                        <stop offset="40%" style="stop-color:#2997ff;stop-opacity:0.5"/>
                        <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:0"/>
                    </radialGradient>
                    <radialGradient id="avatarCore" cx="50%" cy="45%" r="40%">
                        <stop offset="0%" style="stop-color:#93c5fd"/>
                        <stop offset="60%" style="stop-color:#2997ff"/>
                        <stop offset="100%" style="stop-color:#0071e3"/>
                    </radialGradient>
                    <filter id="avatarBlur">
                        <feGaussianBlur stdDeviation="4" result="blur"/>
                        <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                    </filter>
                </defs>
                <circle cx="80" cy="80" r="70" fill="url(#avatarGlow)" opacity=".3"/>
                <g class="avatar-rings">
                    <circle cx="80" cy="80" r="55" fill="none" stroke="#2997ff" stroke-width="1" opacity=".25"/>
                    <circle cx="80" cy="80" r="42" fill="none" stroke="#64d2ff" stroke-width=".8" opacity=".15"/>
                    <circle cx="80" cy="80" r="65" fill="none" stroke="#0071e3" stroke-width=".6" opacity=".1" stroke-dasharray="8 6"/>
                </g>
                <g class="avatar-rays" opacity=".35">
                    <line x1="80" y1="25" x2="80" y2="10" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="130" y1="50" x2="142" y2="40" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="130" y1="110" x2="142" y2="120" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="80" y1="135" x2="80" y2="150" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
                    <line x1="30" y1="50" x2="18" y2="40" stroke="#64d2ff" stroke-width="1.5" stroke-linecap="round"/>
                </g>
                <g class="avatar-core" filter="url(#avatarBlur)">
                    <circle class="avatar-core-circle" cx="80" cy="80" r="16" fill="url(#avatarCore)"/>
                </g>
                <g opacity=".3">
                    <circle cx="80" cy="52" r="2.5" fill="#64d2ff"/>
                    <circle cx="107" cy="68" r="2.5" fill="#64d2ff"/>
                    <circle cx="97" cy="100" r="2.5" fill="#64d2ff"/>
                    <circle cx="63" cy="100" r="2.5" fill="#64d2ff"/>
                    <circle cx="53" cy="68" r="2.5" fill="#64d2ff"/>
                    <line x1="80" y1="52" x2="107" y2="68" stroke="#64d2ff" stroke-width=".5" opacity=".4"/>
                    <line x1="107" y1="68" x2="97" y2="100" stroke="#64d2ff" stroke-width=".5" opacity=".4"/>
                    <line x1="97" y1="100" x2="63" y2="100" stroke="#64d2ff" stroke-width=".5" opacity=".4"/>
                    <line x1="63" y1="100" x2="53" y2="68" stroke="#64d2ff" stroke-width=".5" opacity=".4"/>
                    <line x1="53" y1="68" x2="80" y2="52" stroke="#64d2ff" stroke-width=".5" opacity=".4"/>
                </g>
            </svg>
            <div class="avatar-label" id="avatar-label">MEMBER ADVISORY</div>
            <div class="avatar-status" id="avatar-status">Voice-powered advisory &middot; Tap to listen</div>
        </div>

        <!-- â•â•â• VOICE TOGGLE â•â•â• -->
        <div class="voice-toggle-wrap">
            <div class="voice-toggle-bar">
                <span class="voice-toggle-label">Text</span>
                <div class="voice-toggle active" id="voiceToggle" onclick="toggleVoice()"></div>
                <span class="voice-toggle-label">Voice</span>
            </div>
        </div>

        <!-- â•â•â• INQUIRY TOPICS â•â•â• -->
        <div class="guide-section">
            <div class="guide-title">Smart Contract Allocation</div>
            <div class="topic-grid">
                <div class="topic-card" onclick="askQuestion('How does the smart contract allocation engine work in Helios?')">
                    <div class="topic-marker">âš™</div>
                    <div><div class="topic-text">Allocation Engine</div><div class="topic-sub">Propagation across the connection mesh</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('Walk me through the $100 activation fee allocation â€” where does every dollar go?')">
                    <div class="topic-marker">$</div>
                    <div><div class="topic-text">Fee Allocation</div><div class="topic-sub">Complete dollar breakdown</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('Explain the formula W_h = W_1 times r to the power of h minus 1. What is the allocation at each depth?')">
                    <div class="topic-marker">W</div>
                    <div><div class="topic-text">Weighting Formula</div><div class="topic-sub">W<sub>h</sub> = W<sub>1</sub> Â· r<sup>(hâˆ’1)</sup></div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('What bonuses are available? How do the connection, staking, and activity bonuses work?')">
                    <div class="topic-marker">B</div>
                    <div><div class="topic-text">Bonuses &amp; Staking</div><div class="topic-sub">Certificate lock rewards</div></div>
                </div>
            </div>
        </div>

        <div class="guide-section">
            <div class="guide-title">Certificates &amp; Treasury</div>
            <div class="topic-grid">
                <div class="topic-card" onclick="askQuestion('What are the three certificate types? How do Gold, Bonus, and Staking Certificates work?')">
                    <div class="topic-marker">C</div>
                    <div><div class="topic-text">Certificate Classes</div><div class="topic-sub">Gold, Bonus, Staking NFTs</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('How do I redeem certificates for physical gold or convert to stablecoin?')">
                    <div class="topic-marker">R</div>
                    <div><div class="topic-text">Redemption Process</div><div class="topic-sub">Physical metal or USDC</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('How does the money flow work? Fiat to stablecoin to gold to certificates?')">
                    <div class="topic-marker">F</div>
                    <div><div class="topic-text">Capital Flow</div><div class="topic-sub">5-step money pipeline</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('What precious metals are held in the reserve? How are they verified on-chain?')">
                    <div class="topic-marker">V</div>
                    <div><div class="topic-text">Reserve Verification</div><div class="topic-sub">APMEX + XRPL proof chain</div></div>
                </div>
            </div>
        </div>

        <div class="guide-section">
            <div class="guide-title">Web3 Infrastructure</div>
            <div class="topic-grid">
                <div class="topic-card" onclick="askQuestion('How does Helios use XRPL and Stellar? What role does each blockchain play?')">
                    <div class="topic-marker">X</div>
                    <div><div class="topic-text">XRPL &amp; Stellar</div><div class="topic-sub">Dual-chain settlement</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('What is the .helios namespace and how does member identity work on-chain?')">
                    <div class="topic-marker">.h</div>
                    <div><div class="topic-text">.helios Namespace</div><div class="topic-sub">Decentralized identity</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('How is the SHA-256 proof chain created from physical gold to digital certificate?')">
                    <div class="topic-marker">P</div>
                    <div><div class="topic-text">Proof Chain</div><div class="topic-sub">Gold â†’ IPFS â†’ XRPL</div></div>
                </div>
                <div class="topic-card" onclick="askQuestion('What structural safeguards prevent protocol misuse or fund misappropriation?')">
                    <div class="topic-marker">S</div>
                    <div><div class="topic-text">Integrity Safeguards</div><div class="topic-sub">Structural protections</div></div>
                </div>
            </div>
        </div>

        <!-- â•â•â• CHAT â•â•â• -->
        <div id="chat-container" class="chat-container">
            <div id="chat-messages" class="chat-messages">
                <div class="chat-message assistant">
                    <div class="msg-avatar">H</div>
                    <div class="msg-content">
                        <p>Welcome to the Helios Member Advisory.<br><br>
                        I can provide detailed information on the smart contract allocation engine,
                        gold-backed certificates, Web3 infrastructure (XRPL &amp; Stellar),
                        staking mechanics, and the activation process.<br><br>
                        <strong>Select a topic above</strong>, or type your question below. Voice advisory is available.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Ask about settlements, reserves, allocation, contracts..."
                   class="input-large" autocomplete="off">
            <button id="chat-send" class="btn btn-primary">Submit</button>
        </div>

        <!-- â•â•â• PAGE LINKS â•â•â• -->
        <div class="page-links">
            <a href="/earnings" class="page-link">Allocation Model</a>
            <a href="/certificates" class="page-link">Certificates</a>
            <a href="/treasury" class="page-link">Treasury &amp; Infrastructure</a>
            <a href="/vault/gold" class="page-link">Reserve Assets</a>
            <a href="/metrics" class="page-link">Protocol Metrics</a>
            <a href="/activate" class="page-link">Activate Your Contract</a>
        </div>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
var memberId = localStorage.getItem('helios_id') || null;
var chatMessages = document.getElementById('chat-messages');
var chatInput = document.getElementById('chat-input');
var chatSend = document.getElementById('chat-send');
var avatar = document.getElementById('helios-avatar');
var avatarLabel = document.getElementById('avatar-label');
var avatarStatus = document.getElementById('avatar-status');

var currentAudio = null;
var lastAnswer = null;
var voiceEnabled = true;

// â•â•â• Voice Toggle â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleVoice() {
    var toggle = document.getElementById('voiceToggle');
    voiceEnabled = !voiceEnabled;
    toggle.classList.toggle('active', voiceEnabled);
    avatarStatus.textContent = voiceEnabled
        ? 'Voice advisory active'
        : 'Text-only mode';
}

// â•â•â• Avatar State Machine â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setAvatarState(state) {
    avatar.classList.remove('avatar-speaking', 'avatar-thinking');
    if (state === 'speaking') {
        avatar.classList.add('avatar-speaking');
        avatarLabel.textContent = 'SPEAKING';
        avatarLabel.style.color = 'var(--gold)';
        avatarStatus.textContent = 'Tap to pause';
    } else if (state === 'thinking') {
        avatar.classList.add('avatar-thinking');
        avatarLabel.textContent = 'PROCESSING';
        avatarLabel.style.color = 'var(--text-muted)';
        avatarStatus.textContent = '';
    } else {
        avatarLabel.textContent = 'MEMBER ADVISORY';
        avatarLabel.style.color = '';
        avatarStatus.textContent = voiceEnabled
            ? (lastAnswer ? 'Tap to hear again' : 'Voice advisory active')
            : 'Text-only mode';
    }
}

// Tap avatar to replay / stop
avatar.addEventListener('click', function() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        setAvatarState('idle');
        return;
    }
    if (lastAnswer && voiceEnabled) {
        speakText(null, lastAnswer);
    }
});

// â•â•â• Chat Functions â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMessage(role, text, showVoice) {
    var div = document.createElement('div');
    div.className = 'chat-message ' + role;

    var voiceHtml = '';
    if (role === 'assistant' && showVoice && voiceEnabled) {
        voiceHtml = '<button class="voice-btn" title="Listen">&#128266;</button>';
    }

    div.innerHTML =
        '<div class="msg-avatar">' + (role === 'assistant' ? 'H' : 'M') + '</div>' +
        '<div class="msg-content">' +
            '<p>' + text.replace(/\n/g, '<br>') + '</p>' +
            voiceHtml +
        '</div>';

    if (role === 'assistant' && showVoice) {
        lastAnswer = text;
        var voiceBtn = div.querySelector('.voice-btn');
        if (voiceBtn) {
            voiceBtn.addEventListener('click', function() { speakText(this, text); });
        }
    }

    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    document.getElementById('chat-container').scrollIntoView({ behavior: 'smooth', block: 'end' });
}

async function speakText(btn, text) {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        document.querySelectorAll('.voice-btn.playing').forEach(function(b) {
            b.classList.remove('playing');
            b.innerHTML = '&#128266;';
        });
        setAvatarState('idle');
        return;
    }

    if (btn) { btn.classList.add('playing'); btn.innerHTML = '&#8987;'; }
    setAvatarState('speaking');

    try {
        var res = await fetch('/api/voice/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text: text})
        }).then(function(r) { return r.json(); });

        if (res.success && res.data && res.data.audio) {
            var audioData = 'data:audio/mpeg;base64,' + res.data.audio;
            currentAudio = new Audio(audioData);
            if (btn) btn.innerHTML = '&#9208;&#65039;';

            currentAudio.onended = function() {
                if (btn) { btn.classList.remove('playing'); btn.innerHTML = '&#128266;'; }
                currentAudio = null;
                setAvatarState('idle');
            };
            currentAudio.onerror = function() {
                if (btn) { btn.classList.remove('playing'); btn.innerHTML = '&#128266;'; }
                currentAudio = null;
                setAvatarState('idle');
            };
            currentAudio.play();
        } else {
            if (btn) { btn.classList.remove('playing'); btn.innerHTML = '&#128263;'; setTimeout(function() { btn.innerHTML = '&#128266;'; }, 2000); }
            setAvatarState('idle');
        }
    } catch (err) {
        if (btn) { btn.classList.remove('playing'); btn.innerHTML = '&#128263;'; setTimeout(function() { btn.innerHTML = '&#128266;'; }, 2000); }
        setAvatarState('idle');
    }
}

async function askQuestion(question) {
    if (!question.trim()) return;

    addMessage('user', question);
    chatInput.value = '';
    setAvatarState('thinking');

    var typing = document.createElement('div');
    typing.className = 'chat-message assistant typing';
    typing.innerHTML = '<div class="msg-avatar">H</div><div class="msg-content"><p>Processing inquiry...</p></div>';
    chatMessages.appendChild(typing);
    chatMessages.scrollTop = chatMessages.scrollHeight;

    try {
        var res = await fetch('/api/chat/ask', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question: question, member_id: memberId})
        }).then(function(r) { return r.json(); });

        typing.remove();
        setAvatarState('idle');

        if (res.success) {
            addMessage('assistant', res.data.answer, true);

            if (res.data.follow_up && res.data.follow_up.length > 0) {
                var suggestions = document.createElement('div');
                suggestions.className = 'follow-up';
                suggestions.innerHTML = res.data.follow_up.map(function(q) {
                    return '<button class="follow-btn" onclick="askQuestion(\'' + q.replace(/'/g, "\\'") + '\')">' + q + '</button>';
                }).join('');
                chatMessages.appendChild(suggestions);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Auto-speak if voice is on
            if (voiceEnabled) {
                speakText(null, res.data.answer);
            }
        } else {
            addMessage('assistant', 'Unable to process your inquiry at this time. Please try again.');
        }
    } catch(err) {
        typing.remove();
        setAvatarState('idle');
        addMessage('assistant', 'Connection error. Please try again.');
    }
}

chatSend.addEventListener('click', function() { askQuestion(chatInput.value); });
chatInput.addEventListener('keypress', function(e) { if (e.key === 'Enter') askQuestion(chatInput.value); });

// â•â•â• Auto-greet with voice on first visit â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function() {
    var greeted = sessionStorage.getItem('helios_greeted');
    if (!greeted && voiceEnabled) {
        sessionStorage.setItem('helios_greeted', '1');
        setTimeout(function() {
            var intro = "Welcome to the Helios Member Advisory. " +
                "I can provide detailed information on settlement mechanics, " +
                "reserve composition, allocation formulas, and smart contract structure. " +
                "Select any topic, or ask me your question directly.";
            speakText(null, intro);
        }, 1500);
    }
})();
</script>
{% endblock %}
