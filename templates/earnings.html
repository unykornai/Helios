{% extends "base.html" %}
{% block title %}Settlement Structure — Helios Protocol{% endblock %}
{% block og_title %}Settlement Structure — Helios Protocol{% endblock %}
{% block og_description %}Deterministic allocation model. Distance-weighted settlement across 15 tiers. Complete formula documentation and projection modeling.{% endblock %}
{% block og_url %}/earnings{% endblock %}

{% block head %}
<style>
/* ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
   SETTLEMENT STRUCTURE — Deterministic Allocation Model
   ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ */

.earnings-page { position: relative; z-index: 1; }
.earn-hero {
    text-align: center; padding: 5rem 2rem 3rem;
    position: relative;
}
.earn-hero h1 {
    font-size: 2.2rem; font-weight: 600; color: var(--gold);
    letter-spacing: .1em; margin-bottom: .5rem;
}
.earn-hero .hero-sub {
    color: var(--text-muted); font-size: 1.05rem;
    max-width: 640px; margin: 0 auto 1.5rem; line-height: 1.7;
}

/* ─── Section Layout ──────────────────────────────────────────── */
.earn-section {
    max-width: 960px; margin: 0 auto;
    padding: 0 2rem 4rem;
}
.earn-section h2 {
    font-size: 1.4rem; font-weight: 600; color: var(--text);
    margin-bottom: .5rem;
}
.earn-section .section-desc {
    color: var(--text-muted); font-size: .95rem; line-height: 1.7;
    margin-bottom: 1.5rem; max-width: 720px;
}

/* ─── Settlement Channel Grid ─────────────────────────────────── */
.streams-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.2rem; margin-bottom: 3rem;
}
.stream-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 1.5rem;
    position: relative; overflow: hidden;
    transition: all .3s;
}
.stream-card::before {
    content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    opacity: 0; transition: opacity .3s;
}
.stream-card:hover { border-color: rgba(201,168,76,0.25); transform: translateY(-1px); }
.stream-card:hover::before { opacity: 1; }
.stream-title { font-size: 1.05rem; font-weight: 600; color: var(--text); margin-bottom: .4rem; }
.stream-amount { font-size: 1.3rem; font-weight: 700; color: var(--gold); margin-bottom: .5rem; }
.stream-desc { font-size: .88rem; color: var(--text-muted); line-height: 1.6; }
.stream-tag {
    display: inline-block; margin-top: .75rem;
    padding: .2rem .6rem; border-radius: 4px;
    font-size: .7rem; font-weight: 600; letter-spacing: .05em;
    font-family: 'Inter', sans-serif;
}
.tag-instant { background: rgba(61,139,110,0.12); color: var(--green); }
.tag-tiered { background: rgba(74,126,181,0.12); color: var(--blue); }
.tag-reserve { background: rgba(201,168,76,0.12); color: var(--gold); }

/* ─── Tier Decay Table ────────────────────────────────────────── */
.decay-table-wrap {
    overflow-x: auto; margin-bottom: 3rem;
    border: 1px solid var(--border); border-radius: var(--radius);
}
.decay-table {
    width: 100%; border-collapse: collapse;
    font-size: .88rem;
}
.decay-table th {
    background: rgba(201,168,76,0.06);
    padding: .6rem 1rem; text-align: left;
    font-weight: 600; color: var(--gold);
    border-bottom: 1px solid var(--border);
    font-size: .75rem; text-transform: uppercase; letter-spacing: .06em;
}
.decay-table td {
    padding: .5rem 1rem; border-bottom: 1px solid rgba(36,40,51,0.6);
    color: var(--text);
}
.decay-table tr:hover { background: rgba(201,168,76,0.02); }
.decay-bar {
    display: inline-block; height: 6px; border-radius: 3px;
    background: linear-gradient(90deg, var(--gold), var(--gold-dark));
    vertical-align: middle; margin-left: .5rem;
}
.tier-primary { font-weight: 700; color: var(--gold); }

/* ─── Calculator ──────────────────────────────────────────────── */
.calc-section {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 2rem;
    margin-bottom: 3rem;
}
.calc-section h3 {
    font-size: 1.15rem; font-weight: 600; color: var(--text);
    margin-bottom: .3rem;
}
.calc-subtitle { color: var(--text-muted); font-size: .88rem; margin-bottom: 1.5rem; }
.calc-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;
    margin-bottom: 1.5rem;
}
.calc-input-group label {
    display: block; font-size: .75rem; color: var(--text-muted);
    text-transform: uppercase; letter-spacing: .06em; font-weight: 600;
    margin-bottom: .3rem; font-family: 'Inter', sans-serif;
}
.calc-input-group input, .calc-input-group select {
    width: 100%; padding: .6rem .8rem;
    background: var(--bg); border: 1px solid var(--border);
    border-radius: var(--radius-sm); color: var(--text);
    font-size: 1rem; font-family: 'Inter', sans-serif;
}
.calc-input-group input:focus, .calc-input-group select:focus {
    outline: none; border-color: var(--gold);
    box-shadow: 0 0 0 2px rgba(201,168,76,0.1);
}
.calc-results {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}
.calc-result-card {
    background: var(--bg); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 1rem; text-align: center;
}
.calc-result-label {
    font-size: .7rem; text-transform: uppercase; letter-spacing: .06em;
    color: var(--text-muted); font-weight: 600; margin-bottom: .3rem;
}
.calc-result-value {
    font-size: 1.6rem; font-weight: 700; color: var(--gold);
    font-variant-numeric: tabular-nums; font-family: 'Inter', sans-serif;
}
.calc-result-sub { font-size: .75rem; color: var(--text-muted); margin-top: .2rem; }

/* ─── Projection Cards ───────────────────────────────────────── */
.scenario-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.2rem; margin-bottom: 3rem;
}
.scenario-card {
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 1.5rem;
    text-align: center; transition: all .3s;
}
.scenario-card:hover { border-color: rgba(201,168,76,0.25); transform: translateY(-1px); }
.scenario-label {
    font-size: .75rem; text-transform: uppercase; letter-spacing: .1em;
    color: var(--text-muted); font-weight: 600; margin-bottom: .5rem;
    font-family: 'Inter', sans-serif;
}
.scenario-title { font-size: 1.05rem; font-weight: 600; color: var(--text); margin-bottom: .75rem; }
.scenario-value {
    font-size: 1.8rem; font-weight: 700; color: var(--gold);
    margin-bottom: .3rem; font-family: 'Inter', sans-serif;
}
.scenario-period { font-size: .82rem; color: var(--text-muted); margin-bottom: 1rem; }
.scenario-detail {
    font-size: .82rem; color: var(--text-muted); line-height: 1.6;
    text-align: left;
    border-top: 1px solid var(--border); padding-top: .75rem;
}
.scenario-detail li { margin-bottom: .3rem; list-style: none; padding-left: .5rem; }

/* ─── Reserve Section ─────────────────────────────────────────── */
.gold-benefit {
    background: rgba(201,168,76,0.03);
    border: 1px solid rgba(201,168,76,0.15);
    border-radius: var(--radius); padding: 2rem;
    margin-bottom: 3rem;
}
.gold-benefit h3 { color: var(--gold); font-size: 1.15rem; font-weight: 600; margin-bottom: .5rem; }
.gold-benefit p { color: var(--text-muted); font-size: .92rem; line-height: 1.7; margin-bottom: 1rem; }
.gold-benefit .btn { margin-top: .5rem; }

/* ─── CTA ─────────────────────────────────────────────────────── */
.earn-cta {
    text-align: center; padding: 3rem 2rem 5rem;
}
.earn-cta h2 { font-size: 1.6rem; font-weight: 600; color: var(--text); margin-bottom: .5rem; }
.earn-cta p { color: var(--text-muted); font-size: 1rem; margin-bottom: 1.5rem; max-width: 500px; margin-left: auto; margin-right: auto; }
.earn-cta .btn { font-size: 1rem; padding: .7rem 1.8rem; }

/* ─── Disclaimer ──────────────────────────────────────────────── */
.earnings-disclaimer {
    max-width: 960px; margin: 0 auto; padding: 0 2rem 4rem;
    font-size: .78rem; color: var(--text-muted); line-height: 1.6;
    opacity: 0.7;
}

/* ─── Advisory Link ───────────────────────────────────────────── */
.ask-inline {
    display: flex; align-items: center; gap: 1rem;
    background: var(--bg-card); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 1rem 1.5rem;
    margin-bottom: 3rem; cursor: pointer;
    transition: all .3s; text-decoration: none;
}
.ask-inline:hover { border-color: var(--gold); }
.ask-inline-text h4 { font-size: .95rem; font-weight: 600; color: var(--text); margin-bottom: .15rem; }
.ask-inline-text p { font-size: .82rem; color: var(--text-muted); }

@media (max-width: 768px) {
    .earn-hero h1 { font-size: 1.6rem; }
    .calc-grid { grid-template-columns: 1fr; }
    .scenario-grid { grid-template-columns: 1fr; }
    .streams-grid { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}
<div class="earnings-page">
    <!-- ═══ HERO ═══ -->
    <section class="earn-hero">
        <h1>SETTLEMENT STRUCTURE</h1>
        <p class="hero-sub">
            All distributions follow a deterministic formula. Allocation is weighted by connection
            distance and enforced by the protocol. Settlements are automatic, verifiable,
            and governed by published mathematics.
        </p>
        <p style="color: var(--gold); font-weight: 600; font-size: .8rem; letter-spacing: .12em; opacity: 0.7; font-family: 'Inter', sans-serif;">
            DETERMINISTIC &middot; DISTANCE-WEIGHTED &middot; VERIFIABLE
        </p>
    </section>

    <!-- ═══ 3 SETTLEMENT CHANNELS ═══ -->
    <section class="earn-section">
        <h2>Three Settlement Channels</h2>
        <p class="section-desc">
            The protocol distributes funds through three distinct channels. Each channel operates under
            fixed rules with no discretionary intervention.
        </p>

        <div class="streams-grid">
            <!-- Channel 1: Direct Referral -->
            <div class="stream-card">
                <div class="stream-title">Direct Referral Settlement</div>
                <div class="stream-amount">$22.50 per member</div>
                <div class="stream-desc">
                    When an individual you referred directly completes their membership activation,
                    a fixed settlement of $22.50 is allocated to your account. This is a one-time,
                    per-member, protocol-enforced distribution.
                </div>
                <span class="stream-tag tag-instant">Immediate Settlement</span>
            </div>

            <!-- Channel 2: Tiered Allocation -->
            <div class="stream-card">
                <div class="stream-title">Distance-Weighted Allocation</div>
                <div class="stream-amount">$22.50 at Tier 1</div>
                <div class="stream-desc">
                    When any member within 15 tiers of your position activates, you receive an
                    allocation weighted by distance. Tier 1 = 50%. Tier 2 = 25%. Tier 3 = 12.5%.
                    Deterministic decay through connection depth.
                    <strong>No limit on network size.</strong>
                </div>
                <span class="stream-tag tag-tiered">Ongoing &middot; Distance-Weighted</span>
            </div>

            <!-- Channel 3: Reserve Certificates -->
            <div class="stream-card">
                <div class="stream-title">Reserve Certificate Accrual</div>
                <div class="stream-amount">Asset-Backed</div>
                <div class="stream-desc">
                    Accumulate value in HC-NFT certificates backed by the protocol's physical metal
                    reserves. Certificates are redeemable for gold or silver from APMEX, or
                    convertible to stablecoin. All holdings are verified on XRPL with SHA-256 proof.
                </div>
                <span class="stream-tag tag-reserve">Store of Value &middot; Redeemable</span>
            </div>
        </div>
    </section>

    <!-- ═══ MEMBERSHIP FEE ALLOCATION ═══ -->
    <section class="earn-section">
        <h2>Membership Fee Allocation</h2>
        <p class="section-desc">
            Every $100 membership fee is allocated according to published, fixed percentages.
            No discretionary funds. Every dollar has a declared destination.
        </p>

        <div class="streams-grid" style="grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));">
            <div class="stream-card" style="text-align: center;">
                <div style="font-size: 1.8rem; font-weight: 700; color: var(--gold); font-family: 'Inter', sans-serif;">$45</div>
                <div style="font-size: .82rem; color: var(--text-muted); margin-top: .3rem;">Settlement Pool</div>
                <div style="font-size: .72rem; color: var(--text-muted); margin-top: .2rem;">Distributed through tiers</div>
            </div>
            <div class="stream-card" style="text-align: center;">
                <div style="font-size: 1.8rem; font-weight: 700; color: var(--green); font-family: 'Inter', sans-serif;">$20</div>
                <div style="font-size: .82rem; color: var(--text-muted); margin-top: .3rem;">Liquidity Reserve</div>
                <div style="font-size: .72rem; color: var(--text-muted); margin-top: .2rem;">Certificate redemptions</div>
            </div>
            <div class="stream-card" style="text-align: center;">
                <div style="font-size: 1.8rem; font-weight: 700; color: var(--purple); font-family: 'Inter', sans-serif;">$15</div>
                <div style="font-size: .82rem; color: var(--text-muted); margin-top: .3rem;">Precious Metals Reserve</div>
                <div style="font-size: .72rem; color: var(--text-muted); margin-top: .2rem;">Physical gold acquisition</div>
            </div>
            <div class="stream-card" style="text-align: center;">
                <div style="font-size: 1.8rem; font-weight: 700; color: var(--blue); font-family: 'Inter', sans-serif;">$10</div>
                <div style="font-size: .82rem; color: var(--text-muted); margin-top: .3rem;">Infrastructure</div>
                <div style="font-size: .72rem; color: var(--text-muted); margin-top: .2rem;">Operations &amp; compliance</div>
            </div>
            <div class="stream-card" style="text-align: center;">
                <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-muted); font-family: 'Inter', sans-serif;">$10</div>
                <div style="font-size: .82rem; color: var(--text-muted); margin-top: .3rem;">Protocol Buffer</div>
                <div style="font-size: .72rem; color: var(--text-muted); margin-top: .2rem;">Contingency reserve</div>
            </div>
        </div>
    </section>

    <!-- ═══ TIER DECAY TABLE ═══ -->
    <section class="earn-section">
        <h2>Allocation Weight by Tier</h2>
        <p class="section-desc">
            Settlement weight follows the formula: <strong>weight(tier) = 1/(2<sup>tier</sup>)</strong>.
            Maximum allocation at Tier 1 (direct connections), with deterministic decay at each successive tier.
            After 15 tiers, any fractional remainder is retained in the stability reserve.
        </p>

        <div class="decay-table-wrap">
            <table class="decay-table">
                <thead>
                    <tr>
                        <th>Tier</th>
                        <th>Connection Relationship</th>
                        <th>Weight</th>
                        <th>Settlement from $45</th>
                        <th>Proportion</th>
                    </tr>
                </thead>
                <tbody id="decayTable"></tbody>
            </table>
        </div>
    </section>

    <!-- ═══ MEMBER ADVISORY LINK ═══ -->
    <section class="earn-section">
        <a href="/ask" class="ask-inline">
            <div class="ask-inline-text">
                <h4>Questions about the settlement model?</h4>
                <p>Our AI-powered Member Advisory can explain any aspect of the allocation formula, reserve structure, or tier mechanics in detail.</p>
            </div>
        </a>
    </section>

    <!-- ═══ SETTLEMENT CALCULATOR ═══ -->
    <section class="earn-section">
        <div class="calc-section">
            <h3>Settlement Projection Calculator</h3>
            <p class="calc-subtitle">Model potential settlements based on your referral activity and network configuration.</p>

            <div class="calc-grid">
                <div class="calc-input-group">
                    <label>Active Referral Positions (max 5)</label>
                    <input type="range" id="calcBonds" min="1" max="5" value="5" oninput="recalculate()">
                    <div style="display: flex; justify-content: space-between; font-size: .75rem; color: var(--text-muted); font-family: 'Inter', sans-serif;">
                        <span>1 position</span><span id="bondDisplay">5 positions</span><span>5 positions</span>
                    </div>
                </div>
                <div class="calc-input-group">
                    <label>New Members Per Month (in your network)</label>
                    <input type="number" id="calcMonthly" min="1" max="500" value="25" oninput="recalculate()">
                </div>
                <div class="calc-input-group">
                    <label>Average Tier Distance</label>
                    <select id="calcAvgHop" onchange="recalculate()">
                        <option value="1">Tier 1 — Direct referrals</option>
                        <option value="2" selected>Tier 2 — Second-degree connections</option>
                        <option value="3">Tier 3 — Third-degree connections</option>
                        <option value="4">Tier 4 — Extended network</option>
                        <option value="5">Tier 5 — Deep network</option>
                    </select>
                </div>
                <div class="calc-input-group">
                    <label>Projection Period</label>
                    <select id="calcTimeframe" onchange="recalculate()">
                        <option value="1">1 Month</option>
                        <option value="3" selected>3 Months</option>
                        <option value="6">6 Months</option>
                        <option value="12">12 Months</option>
                    </select>
                </div>
            </div>

            <div class="calc-results">
                <div class="calc-result-card">
                    <div class="calc-result-label">Tiered Allocation</div>
                    <div class="calc-result-value" id="resultPropagation">$0</div>
                    <div class="calc-result-sub">from network activations</div>
                </div>
                <div class="calc-result-card">
                    <div class="calc-result-label">Direct Referral Settlements</div>
                    <div class="calc-result-value" id="resultAcknowledge">$0</div>
                    <div class="calc-result-sub">$22.50 per direct member</div>
                </div>
                <div class="calc-result-card">
                    <div class="calc-result-label">Total Projected Settlement</div>
                    <div class="calc-result-value" id="resultTotal">$0</div>
                    <div class="calc-result-sub" id="resultPeriod">over 3 months</div>
                </div>
            </div>
        </div>
    </section>

    <!-- ═══ DETERMINISTIC PROJECTIONS ═══ -->
    <section class="earn-section">
        <h2>Deterministic Settlement Projections</h2>
        <p class="section-desc">
            Derived from protocol mathematics. weight(tier) = 1/(2<sup>tier</sup>). $45 settlement pool per $100 membership.
            $22.50 direct referral settlement per activation.
        </p>

        <div class="scenario-grid">
            <div class="scenario-card">
                <div class="scenario-label">Conservative</div>
                <div class="scenario-title">5 Referrals &middot; Limited Network</div>
                <div class="scenario-value">$742</div>
                <div class="scenario-period">projected monthly settlement</div>
                <ul class="scenario-detail">
                    <li>5 direct referral positions utilized</li>
                    <li>10 new activations/month in network</li>
                    <li>Average tier distance: 2</li>
                    <li>Tiered allocation: $112.50/mo</li>
                    <li>Direct settlement: ~$30/mo</li>
                    <li>Certificate accrual commencing</li>
                </ul>
            </div>
            <div class="scenario-card" style="border-color: rgba(201,168,76,0.2);">
                <div class="scenario-label" style="color: var(--gold);">Moderate</div>
                <div class="scenario-title">5 Referrals &middot; Active Network</div>
                <div class="scenario-value">$3,375</div>
                <div class="scenario-period">projected monthly settlement</div>
                <ul class="scenario-detail">
                    <li>All 5 referral positions occupied</li>
                    <li>50 new activations/month in network</li>
                    <li>Average tier distance: 2</li>
                    <li>Tiered allocation: $562.50/mo</li>
                    <li>Direct settlement: ~$50/mo</li>
                    <li>Substantial certificate position</li>
                </ul>
            </div>
            <div class="scenario-card">
                <div class="scenario-label">Established</div>
                <div class="scenario-title">5 Referrals &middot; Sustained Growth</div>
                <div class="scenario-value">$8,100</div>
                <div class="scenario-period">projected monthly settlement</div>
                <ul class="scenario-detail">
                    <li>Full referral capacity utilized</li>
                    <li>150 new activations/month in network</li>
                    <li>Average tier: mixed (1-3)</li>
                    <li>Tiered allocation: $5,062.50/mo</li>
                    <li>Direct settlement: ~$50/mo</li>
                    <li>Active reserve certificate redemption</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- ═══ RESERVE BENEFIT ═══ -->
    <section class="earn-section">
        <div class="gold-benefit">
            <h3>Settlement Proceeds May Be Converted to Physical Metal</h3>
            <p>
                Allocations received through the settlement protocol may be accumulated in HC-NFT certificates.
                These certificates are redeemable for <strong>physical gold bars and rounds through APMEX</strong>,
                one of the world's largest accredited precious metals dealers.
                Each metal transaction is anchored on XRPL with SHA-256 proof of custody.
            </p>
            <p>
                Reserve composition is publicly verifiable: <strong>GET /api/treasury/reserves</strong>
            </p>
            <a href="/vault/gold" class="btn btn-primary">View Reserve Holdings</a>
            <a href="/treasury" class="btn btn-ghost" style="margin-left: .5rem;">Verify Proof of Reserves</a>
        </div>
    </section>

    <!-- ═══ CTA ═══ -->
    <section class="earn-cta">
        <h2>Begin Receiving Deterministic Settlements</h2>
        <p>$100 membership. Fixed allocation formula. Every dollar verifiable.</p>
        <a href="/activate" class="btn btn-primary">Apply for Membership</a>
        <a href="/ask" class="btn btn-ghost" style="margin-left: .5rem;">Consult Member Advisory</a>
    </section>

    <!-- ═══ DISCLAIMER ═══ -->
    <div class="earnings-disclaimer">
        <strong>Disclaimer:</strong> All projections are mathematical models derived from the protocol's deterministic
        settlement formula: weight(tier) = 1/(2^tier) applied to the $45 allocation pool per $100 membership activation.
        Actual settlements depend on network activity within your connection structure and the number of occupied
        referral positions. These projections do not constitute guarantees of income. Helios operates as a private
        membership protocol with formula-governed settlement. Projected figures are based on mathematical models,
        not historical investment returns.
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// ─── Tier Decay Table ────────────────────────────────────────────
function buildDecayTable() {
    var tbody = document.getElementById('decayTable');
    var tiers = [
        { tier: 1, label: 'Direct referral (your member)', primary: true },
        { tier: 2, label: 'Second-degree connection', primary: false },
        { tier: 3, label: 'Third-degree connection', primary: false },
        { tier: 4, label: 'Fourth-degree connection', primary: false },
        { tier: 5, label: 'Fifth-degree connection', primary: false },
        { tier: 6, label: 'Sixth-degree connection', primary: false },
        { tier: 7, label: 'Seventh-degree connection', primary: false },
        { tier: 8, label: 'Eighth-degree connection', primary: false },
        { tier: 10, label: 'Tenth-degree connection', primary: false },
        { tier: 15, label: 'Maximum settlement horizon', primary: false },
    ];

    var pool = 45;
    var rows = '';

    tiers.forEach(function(t) {
        var weight = 1 / Math.pow(2, t.tier);
        var settlement = pool * weight;
        var pct = weight * 100;
        var barWidth = Math.max(2, pct * 3);
        var cls = t.primary ? ' class="tier-primary"' : '';

        rows += '<tr>' +
            '<td' + cls + '>Tier ' + t.tier + '</td>' +
            '<td' + cls + '>' + t.label + '</td>' +
            '<td' + cls + '>' + (pct >= 0.01 ? pct.toFixed(pct >= 1 ? 1 : 2) + '%' : '<0.01%') + '</td>' +
            '<td' + cls + '>$' + (settlement >= 0.01 ? settlement.toFixed(2) : settlement.toFixed(4)) + '</td>' +
            '<td><span class="decay-bar" style="width: ' + barWidth + 'px;"></span></td>' +
            '</tr>';
    });

    tbody.innerHTML = rows;
}

// ─── Calculator ──────────────────────────────────────────────────
function recalculate() {
    var bonds = parseInt(document.getElementById('calcBonds').value);
    var monthly = parseInt(document.getElementById('calcMonthly').value) || 0;
    var avgTier = parseInt(document.getElementById('calcAvgHop').value);
    var months = parseInt(document.getElementById('calcTimeframe').value);

    document.getElementById('bondDisplay').textContent = bonds + ' position' + (bonds > 1 ? 's' : '');

    var weight = 1 / Math.pow(2, avgTier);
    var allocationPerMember = 45 * weight;
    var totalAllocation = allocationPerMember * monthly * months;

    var directPerMonth = Math.min(bonds, Math.ceil(monthly * 0.2));
    var directValue = directPerMonth * 22.50;
    var totalDirect = directValue * months;

    var total = totalAllocation + totalDirect;

    document.getElementById('resultPropagation').textContent = '$' + formatNum(totalAllocation);
    document.getElementById('resultAcknowledge').textContent = '$' + formatNum(totalDirect);
    document.getElementById('resultTotal').textContent = '$' + formatNum(total);
    document.getElementById('resultPeriod').textContent = 'over ' + months + ' month' + (months > 1 ? 's' : '');
}

function formatNum(n) {
    if (n >= 1000) return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
    if (n >= 1) return n.toFixed(2);
    return n.toFixed(4);
}

// ─── Init ────────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', function() {
    buildDecayTable();
    recalculate();
});
</script>
{% endblock %}
